#!/bin/bash

# Script de test pour la solution de backup ASPHub 3-2-1
# Ce script vÃ©rifie que tous les composants sont en place

set -e

echo "ğŸ§ª Test de la solution de backup ASPHub 3-2-1"
echo "=============================================="

# VÃ©rification 1: Conteneur de backup
echo "1. VÃ©rification du conteneur de backup..."
if docker ps --format "table {{.Names}}" | grep -q "asphub_backup"; then
    echo "âœ… Conteneur asphub_backup en cours d'exÃ©cution"
else
    echo "âŒ Conteneur asphub_backup non trouvÃ©"
    exit 1
fi

# VÃ©rification 2: Volumes
echo "2. VÃ©rification des volumes..."
POSTGRES_VOL=$(docker volume ls | grep postgres_data | wc -l)
MINIO_VOL=$(docker volume ls | grep minio_data | wc -l)
BACKUP_VOL=$(docker volume ls | grep backup_data | wc -l)

if [[ $POSTGRES_VOL -eq 1 ]]; then
    echo "âœ… Volume postgres_data prÃ©sent"
else
    echo "âŒ Volume postgres_data manquant"
fi

if [[ $MINIO_VOL -eq 1 ]]; then
    echo "âœ… Volume minio_data prÃ©sent"
else
    echo "âŒ Volume minio_data manquant"
fi

if [[ $BACKUP_VOL -eq 1 ]]; then
    echo "âœ… Volume backup_data prÃ©sent"
else
    echo "âŒ Volume backup_data manquant"
fi

# VÃ©rification 3: Configuration
echo "3. VÃ©rification de la configuration..."
if [[ -f "/opt/backup/.env" ]]; then
    echo "âœ… Fichier de configuration prÃ©sent"
else
    echo "âŒ Fichier de configuration manquant"
    exit 1
fi

# VÃ©rification 4: Scripts de gestion
echo "4. VÃ©rification des scripts de gestion..."
SCRIPTS=(
    "/opt/backup/scripts/backup-now.sh"
    "/opt/backup/scripts/backup-status.sh"
    "/opt/backup/scripts/restore-script.sh"
)

for script in "${SCRIPTS[@]}"; do
    if [[ -f "$script" && -x "$script" ]]; then
        echo "âœ… Script $(basename $script) prÃ©sent et exÃ©cutable"
    else
        echo "âŒ Script $(basename $script) manquant ou non exÃ©cutable"
    fi
done

# VÃ©rification 5: Plakar dans le conteneur
echo "5. VÃ©rification de Plakar dans le conteneur..."
if docker exec asphub_backup plakar version >/dev/null 2>&1; then
    PLAKAR_VERSION=$(docker exec asphub_backup plakar version)
    echo "âœ… Plakar disponible: $PLAKAR_VERSION"
else
    echo "âŒ Plakar non disponible dans le conteneur"
    exit 1
fi

# VÃ©rification 6: Repositories configurÃ©s
echo "6. VÃ©rification des repositories..."
echo "   ğŸ“ Local: /backup/storage/local"
echo "   ğŸŒ SFTP: {{ vault_backup_sftp_user }}@{{ vault_backup_sftp_host }}{{ vault_backup_sftp_path }}"
echo "   â˜ï¸  S3: {{ vault_backup_s3_region }}.amazonaws.com/{{ vault_backup_s3_bucket }}"

# VÃ©rification 7: Cron dans le conteneur
echo "7. VÃ©rification du cron..."
if docker exec asphub_backup crontab -l | grep -q "backup-script.sh"; then
    echo "âœ… Cron job configurÃ©"
    docker exec asphub_backup crontab -l
else
    echo "âŒ Cron job non configurÃ©"
fi

# Test de backup simple (optionnel)
echo "8. Test de backup simple..."
echo "   Pour tester un backup manuel, exÃ©cutez:"
echo "   /opt/backup/scripts/backup-now.sh"

echo ""
echo "ğŸ‰ VÃ©rification terminÃ©e!"
echo ""
echo "ğŸ“‹ RÃ©sumÃ© de la configuration:"
echo "   - StratÃ©gie: 3-2-1 (3 copies, 2 supports, 1 externe)"
echo "   - FrÃ©quence: Quotidien Ã  2h00"
echo "   - RÃ©tention: {{ backup_retention_days }} jours"
echo "   - Volumes sauvegardÃ©s: postgres_data, minio_data"
echo ""
echo "ğŸ”§ Commandes utiles:"
echo "   - Status: /opt/backup/scripts/backup-status.sh"
echo "   - Backup manuel: /opt/backup/scripts/backup-now.sh"
echo "   - Restore: /opt/backup/scripts/restore-script.sh"
echo "   - Logs: docker logs asphub_backup" 