#!/bin/bash

# Script pour vÃ©rifier le statut des backups
# Affiche l'Ã©tat du conteneur et des derniers backups

set -e

echo "ğŸ“Š ASPHub Backup Status"
echo "======================"

# VÃ©rifier l'Ã©tat du conteneur
echo "ğŸ³ Container Status:"
if docker ps --format "table {{.Names}}\t{{.Status}}" | grep -q "asphub_backup"; then
    docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | grep "asphub_backup"
    echo "âœ… Backup container is running"
else
    echo "âŒ Backup container is not running"
    exit 1
fi

echo ""

# VÃ©rifier les volumes
echo "ğŸ’¾ Volume Status:"
echo "- postgres_data: $(docker volume ls | grep postgres_data | awk '{print $2}')"
echo "- minio_data: $(docker volume ls | grep minio_data | awk '{print $2}')"
echo "- backup_data: $(docker volume ls | grep backup_data | awk '{print $2}')"

echo ""

# Afficher les derniers logs du conteneur
echo "ğŸ“ Recent Logs (last 10 lines):"
docker logs --tail 10 asphub_backup

echo ""

# VÃ©rifier le statut du dernier backup s'il existe
echo "ğŸ“ˆ Last Backup Status:"
if docker exec asphub_backup test -f /backup/storage/last_backup_status.json; then
    echo "Last backup information:"
    docker exec asphub_backup cat /backup/storage/last_backup_status.json | jq -r '
        "  ğŸ“… Date: " + .timestamp + 
        "\n  ğŸ†” ID: " + .backup_id + 
        "\n  ğŸ“Š Status: " + .status + 
        "\n  ğŸ’¾ PostgreSQL: " + .postgres_size + 
        "\n  ğŸ“ MinIO: " + .minio_size + 
        "\n  ğŸ“¦ Total: " + .total_size'
else
    echo "No backup status file found. Run a backup first."
fi

echo ""

# Lister les snapshots disponibles
echo "ğŸ“¦ Available Snapshots:"
if docker exec asphub_backup plakar -repository /backup/storage/local snapshots 2>/dev/null; then
    echo "âœ… Snapshots listed above"
else
    echo "âŒ No snapshots found or repository not initialized"
fi

echo ""
echo "ğŸ”§ Management Commands:"
echo "- Manual backup: /opt/backup/scripts/backup-now.sh"
echo "- Restore data: /opt/backup/scripts/restore-script.sh"
echo "- Container logs: docker logs asphub_backup"
echo "- Container shell: docker exec -it asphub_backup /bin/sh" 